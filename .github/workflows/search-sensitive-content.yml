name: Search Sensitive Content in JSON Files

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ

jobs:
  search-sensitive-content:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Search for sensitive content in JSON files
      run: |
        echo "ğŸ” æœç´¢åŒ…å«æ•æ„Ÿå†…å®¹çš„ JSON æ–‡ä»¶..."
        echo "======================================="
        
        # åˆ›å»ºç»“æœæ–‡ä»¶
        touch search_results.txt
        echo "æœç´¢ç»“æœ - $(date)" > search_results.txt
        echo "=======================================" >> search_results.txt
        
        # æœç´¢åŒ…å«ç‰¹å®šæ¨¡å¼çš„ JSON æ–‡ä»¶
        found_files=$(find . -name "*.json" -type f -exec grep -l "sk-ant-oat01-" {} \; 2>/dev/null || true)
        
        if [ -z "$found_files" ]; then
          echo "âœ… æœªå‘ç°åŒ…å«æ•æ„Ÿå†…å®¹çš„ JSON æ–‡ä»¶"
          echo "âœ… æœªå‘ç°åŒ…å«æ•æ„Ÿå†…å®¹çš„ JSON æ–‡ä»¶" >> search_results.txt
        else
          echo "âš ï¸  å‘ç°ä»¥ä¸‹æ–‡ä»¶åŒ…å«æ•æ„Ÿå†…å®¹:"
          echo "âš ï¸  å‘ç°ä»¥ä¸‹æ–‡ä»¶åŒ…å«æ•æ„Ÿå†…å®¹:" >> search_results.txt
          echo "" >> search_results.txt
          
          for file in $found_files; do
            echo "æ–‡ä»¶: $file"
            echo "æ–‡ä»¶: $file" >> search_results.txt
            
            # è·å–æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´
            last_modified=$(git log -1 --format="%cd" --date=format:'%Y-%m-%d %H:%M:%S' -- "$file" 2>/dev/null || echo "æœªçŸ¥")
            echo "  æœ€åä¿®æ”¹æ—¶é—´: $last_modified"
            echo "  æœ€åä¿®æ”¹æ—¶é—´: $last_modified" >> search_results.txt
            
            # è·å–æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ï¼ˆé¦–æ¬¡æäº¤æ—¶é—´ï¼‰
            first_commit=$(git log --follow --format="%cd" --date=format:'%Y-%m-%d %H:%M:%S' -- "$file" | tail -1 2>/dev/null || echo "æœªçŸ¥")
            echo "  é¦–æ¬¡åˆ›å»ºæ—¶é—´: $first_commit"
            echo "  é¦–æ¬¡åˆ›å»ºæ—¶é—´: $first_commit" >> search_results.txt
            
            # è·å–æ–‡ä»¶å¤§å°
            file_size=$(du -h "$file" | cut -f1)
            echo "  æ–‡ä»¶å¤§å°: $file_size"
            echo "  æ–‡ä»¶å¤§å°: $file_size" >> search_results.txt
            
            # æ˜¾ç¤ºåŒ¹é…çš„è¡Œæ•°
            match_count=$(grep -c "sk-ant-oat01-" "$file" 2>/dev/null || echo "0")
            echo "  åŒ¹é…è¡Œæ•°: $match_count"
            echo "  åŒ¹é…è¡Œæ•°: $match_count" >> search_results.txt
            
            # æ˜¾ç¤ºåŒ¹é…çš„å…·ä½“è¡Œï¼ˆè„±æ•å¤„ç†ï¼‰
            echo "  åŒ¹é…å†…å®¹é¢„è§ˆ:"
            echo "  åŒ¹é…å†…å®¹é¢„è§ˆ:" >> search_results.txt
            grep -n "sk-ant-oat01-" "$file" | head -3 | sed 's/sk-ant-oat01-[^"]*/"[REDACTED_API_KEY]"/g' | while read line; do
              echo "    $line"
              echo "    $line" >> search_results.txt
            done
            
            echo ""
            echo "" >> search_results.txt
          done
        fi

    - name: Create detailed report
      run: |
        echo "ğŸ“Š åˆ›å»ºè¯¦ç»†æŠ¥å‘Š..."
        
        # åˆ›å»º Python è„šæœ¬æ¥ç”Ÿæˆæ›´è¯¦ç»†çš„æŠ¥å‘Š
        cat > generate_report.py << 'EOF'
        import os
        import json
        import subprocess
        from datetime import datetime
        
        def get_git_info(file_path):
            try:
                # è·å–æœ€åä¿®æ”¹æ—¶é—´
                last_modified = subprocess.check_output([
                    'git', 'log', '-1', '--format=%cd', '--date=iso', '--', file_path
                ], stderr=subprocess.DEVNULL).decode().strip()
                
                # è·å–é¦–æ¬¡æäº¤æ—¶é—´
                first_commit = subprocess.check_output([
                    'git', 'log', '--follow', '--format=%cd', '--date=iso', '--', file_path
                ], stderr=subprocess.DEVNULL).decode().strip().split('\n')[-1]
                
                # è·å–æœ€åä¿®æ”¹çš„æäº¤å“ˆå¸Œå’Œä½œè€…
                commit_info = subprocess.check_output([
                    'git', 'log', '-1', '--format=%H|%an|%ae', '--', file_path
                ], stderr=subprocess.DEVNULL).decode().strip().split('|')
                
                return {
                    'last_modified': last_modified,
                    'first_commit': first_commit,
                    'last_commit_hash': commit_info[0] if len(commit_info) > 0 else 'N/A',
                    'last_author_name': commit_info[1] if len(commit_info) > 1 else 'N/A',
                    'last_author_email': commit_info[2] if len(commit_info) > 2 else 'N/A'
                }
            except:
                return {
                    'last_modified': 'Unknown',
                    'first_commit': 'Unknown',
                    'last_commit_hash': 'N/A',
                    'last_author_name': 'N/A',
                    'last_author_email': 'N/A'
                }
        
        def search_sensitive_content():
            results = []
            
            # æœç´¢æ‰€æœ‰ JSON æ–‡ä»¶
            for root, dirs, files in os.walk('.'):
                # è·³è¿‡ .git ç›®å½•
                if '.git' in root:
                    continue
                    
                for file in files:
                    if file.endswith('.json'):
                        file_path = os.path.join(root, file)
                        try:
                            with open(file_path, 'r', encoding='utf-8') as f:
                                content = f.read()
                                if 'sk-ant-oat01-' in content:
                                    git_info = get_git_info(file_path)
                                    file_stat = os.stat(file_path)
                                    
                                    # è®¡ç®—åŒ¹é…æ¬¡æ•°
                                    match_count = content.count('sk-ant-oat01-')
                                    
                                    results.append({
                                        'file_path': file_path,
                                        'file_size': file_stat.st_size,
                                        'match_count': match_count,
                                        'git_info': git_info
                                    })
                        except Exception as e:
                            print(f"Error reading {file_path}: {e}")
            
            return results
        
        # ç”ŸæˆæŠ¥å‘Š
        results = search_sensitive_content()
        
        with open('detailed_report.json', 'w', encoding='utf-8') as f:
            json.dump({
                'scan_time': datetime.now().isoformat(),
                'total_files_found': len(results),
                'results': results
            }, f, indent=2, ensure_ascii=False)
        
        print(f"æ‰¾åˆ° {len(results)} ä¸ªåŒ…å«æ•æ„Ÿå†…å®¹çš„æ–‡ä»¶")
        for result in results:
            print(f"\næ–‡ä»¶: {result['file_path']}")
            print(f"  å¤§å°: {result['file_size']} bytes")
            print(f"  åŒ¹é…æ¬¡æ•°: {result['match_count']}")
            print(f"  æœ€åä¿®æ”¹: {result['git_info']['last_modified']}")
            print(f"  é¦–æ¬¡åˆ›å»º: {result['git_info']['first_commit']}")
            print(f"  æœ€åæäº¤: {result['git_info']['last_commit_hash']}")
            print(f"  æœ€åä½œè€…: {result['git_info']['last_author_name']} <{result['git_info']['last_author_email']}>")
        EOF
        
        python generate_report.py

    - name: Upload search results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: sensitive-content-search-results
        path: |
          search_results.txt
          detailed_report.json
        retention-days: 30

    - name: Send notification (optional)
      if: hashFiles('search_results.txt') && contains(hashFiles('search_results.txt'), 'sensitive')
      run: |
        echo "âš ï¸  æ£€æµ‹åˆ°æ•æ„Ÿå†…å®¹ï¼Œè¯·æ£€æŸ¥ä¸Šä¼ çš„æŠ¥å‘Šæ–‡ä»¶"
        echo "å¯ä»¥åœ¨ Actions çš„ Artifacts ä¸­ä¸‹è½½è¯¦ç»†æŠ¥å‘Š"
        
        # å¦‚æœé…ç½®äº† Webhookï¼Œå¯ä»¥å‘é€é€šçŸ¥
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"âš ï¸ GitHubä»“åº“ä¸­æ£€æµ‹åˆ°æ•æ„ŸAPIå¯†é’¥ï¼Œè¯·ç«‹å³æ£€æŸ¥ï¼"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Security recommendations
      run: |
        echo "ğŸ”’ å®‰å…¨å»ºè®®:"
        echo "1. å¦‚æœå‘ç°æ•æ„Ÿå†…å®¹ï¼Œè¯·ç«‹å³æ›´æ¢ç›¸å…³çš„ API å¯†é’¥"
        echo "2. ä½¿ç”¨ git filter-branch æˆ– BFG Repo-Cleaner æ¸…ç†å†å²è®°å½•"
        echo "3. å°†æ•æ„Ÿä¿¡æ¯ç§»åŠ¨åˆ°ç¯å¢ƒå˜é‡æˆ– GitHub Secrets"
        echo "4. æ·»åŠ  .gitignore è§„åˆ™é˜²æ­¢æœªæ¥è¯¯æäº¤"
        echo "5. è€ƒè™‘ä½¿ç”¨ pre-commit hooks è¿›è¡Œæäº¤å‰æ£€æŸ¥"
