name: GitHub Code Search for Sensitive Content

on:
  workflow_dispatch:
    inputs:
      search_scope:
        description: 'æœç´¢èŒƒå›´ (user:username æˆ– org:orgnameï¼Œç•™ç©ºæœç´¢æ‰€æœ‰å…¬å¼€ä»“åº“)'
        required: false
        default: ''
      max_results:
        description: 'æœ€å¤§ç»“æžœæ•°é‡'
        required: false
        default: '100'
      search_pattern:
        description: 'æœç´¢æ¨¡å¼'
        required: false
        default: 'sk-ant-oat01-'
      file_extensions:
        description: 'æ–‡ä»¶æ‰©å±•å (å¦‚: json,yaml,txt)'
        required: false
        default: 'json'
      use_regex:
        description: 'ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å®Œæ•´å¯†é’¥'
        required: false
        default: 'true'
        type: boolean
      force_notify:
        description: 'å¼ºåˆ¶å‘é€é€šçŸ¥'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # åŒ—äº¬æ—¶é—´ 8-16 ç‚¹æ¯å°æ—¶è¿è¡Œ (UTC 0-8ç‚¹)
    - cron: '0 0 * * *'   # åŒ—äº¬æ—¶é—´ 08:00 (UTC 00:00)
    - cron: '0 1 * * *'   # åŒ—äº¬æ—¶é—´ 09:00 (UTC 01:00)
    - cron: '0 2 * * *'   # åŒ—äº¬æ—¶é—´ 10:00 (UTC 02:00)
    - cron: '0 3 * * *'   # åŒ—äº¬æ—¶é—´ 11:00 (UTC 03:00)
    - cron: '0 4 * * *'   # åŒ—äº¬æ—¶é—´ 12:00 (UTC 04:00)
    - cron: '0 5 * * *'   # åŒ—äº¬æ—¶é—´ 13:00 (UTC 05:00)
    - cron: '0 6 * * *'   # åŒ—äº¬æ—¶é—´ 14:00 (UTC 06:00)
    - cron: '0 7 * * *'   # åŒ—äº¬æ—¶é—´ 15:00 (UTC 07:00)
    - cron: '0 8 * * *'   # åŒ—äº¬æ—¶é—´ 16:00 (UTC 08:00)
    # å…¶ä»–æ—¶é—´æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 12 * * *'  # åŒ—äº¬æ—¶é—´ 20:00 (UTC 12:00)
    - cron: '0 16 * * *'  # åŒ—äº¬æ—¶é—´ 00:00 (UTC 16:00)
    - cron: '0 20 * * *'  # åŒ—äº¬æ—¶é—´ 04:00 (UTC 20:00)

env:
  TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´

jobs:
  github-code-search:
    runs-on: ubuntu-latest
    
    steps:
    - name: Show current time
      run: |
        echo "å½“å‰ UTC æ—¶é—´: $(date -u)"
        echo "å½“å‰åŒ—äº¬æ—¶é—´: $(TZ=Asia/Shanghai date)"
        echo "é¢„æœŸè¿è¡Œæ—¶é—´éªŒè¯å®Œæˆ"
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        pip install requests python-dateutil

    - name: Check previous results
      id: check_previous
      run: |
        # åˆ›å»ºåŽ†å²è®°å½•ç›®å½•
        mkdir -p .github/scan_history
        
        # ä¸‹è½½ä¹‹å‰çš„åŽ†å²è®°å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if gh run list --workflow="GitHub Code Search for Sensitive Content" --limit=1 --json databaseId,conclusion | jq -r '.[0].databaseId' > /dev/null 2>&1; then
          echo "å°è¯•æ¢å¤åŽ†å²è®°å½•..."
          gh run download --name="github-code-search-results-*" --dir=temp_history 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°åŽ†å²è®°å½•"
          if [ -d "temp_history" ]; then
            find temp_history -name "last_scan_hash.txt" -exec cp {} .github/scan_history/ \; 2>/dev/null || true
            rm -rf temp_history
          fi
        fi
        
        # èŽ·å–ä¸Šæ¬¡æ‰«æç»“æžœçš„å“ˆå¸Œå€¼
        if [ -f ".github/scan_history/last_scan_hash.txt" ]; then
          previous_hash=$(cat .github/scan_history/last_scan_hash.txt)
          echo "previous_hash=$previous_hash" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ°åŽ†å²å“ˆå¸Œ: $previous_hash"
        else
          echo "previous_hash=" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°åŽ†å²è®°å½•ï¼Œè¿™æ˜¯é¦–æ¬¡è¿è¡Œ"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run GitHub Code Search
      id: search
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SEARCH_SCOPE: ${{ github.event.inputs.search_scope }}
        MAX_RESULTS: ${{ github.event.inputs.max_results || '100' }}
        SEARCH_PATTERN: ${{ github.event.inputs.search_pattern || 'sk-ant-oat01-' }}
        FILE_EXTENSIONS: ${{ github.event.inputs.file_extensions || 'json' }}
        USE_REGEX: ${{ github.event.inputs.use_regex || 'true' }}
        PREVIOUS_HASH: ${{ steps.check_previous.outputs.previous_hash }}
      run: |
        python scripts/github_search.py

    - name: Generate reports
      run: |
        python scripts/generate_reports.py

    - name: Check for new findings
      id: check_new
      run: |
        python scripts/check_new_findings.py

    - name: Send Bark notification
      if: steps.check_new.outputs.has_new_findings == 'true' || github.event.inputs.force_notify == 'true'
      env:
        BARK_KEY: ${{ secrets.BARK_KEY }}
        BARK_SERVER: ${{ secrets.BARK_SERVER }}
      run: |
        python scripts/send_bark_notification.py

    - name: Update scan history
      run: |
        python scripts/update_scan_history.py

    - name: Upload search results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: github-code-search-results-${{ github.run_number }}
        path: |
          reports/
          .github/scan_history/
        retention-days: 30

    - name: Create security summary
      if: always()
      run: |
        python scripts/create_summary.py

    - name: Security recommendations
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”’ å®‰å…¨å»ºè®®" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **ç«‹å³è¡ŒåŠ¨**: å¦‚æžœåœ¨å…¬å¼€ä»“åº“ä¸­å‘çŽ°æ•æ„Ÿå†…å®¹ï¼Œè¯·ç«‹å³æ›´æ¢ç›¸å…³çš„ API å¯†é’¥" >> $GITHUB_STEP_SUMMARY
        echo "2. **æ¸…ç†åŽ†å²**: ä½¿ç”¨ git filter-branch æˆ– BFG Repo-Cleaner æ¸…ç† Git åŽ†å²è®°å½•" >> $GITHUB_STEP_SUMMARY
        echo "3. **è”ç³»ä»“åº“æ‰€æœ‰è€…**: å¦‚æžœæ•æ„Ÿå†…å®¹åœ¨ä»–äººä»“åº“ä¸­ï¼Œè¯·è”ç³»ä»“åº“æ‰€æœ‰è€…" >> $GITHUB_STEP_SUMMARY
        echo "4. **å¯ç”¨ç›‘æŽ§**: è€ƒè™‘ä½¿ç”¨ GitHub secret scanning æˆ–å…¶ä»–å®‰å…¨å·¥å…·" >> $GITHUB_STEP_SUMMARY
        echo "5. **é¢„é˜²æŽªæ–½**: ä½¿ç”¨ pre-commit hooks å’Œ .gitignore é˜²æ­¢æœªæ¥æ³„éœ²" >> $GITHUB_STEP_SUMMARY
